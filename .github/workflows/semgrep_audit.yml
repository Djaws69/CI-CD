name: Semgrep

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  semgrep:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Semgrep
        run: pip install semgrep

      
      - name: Semgrep scan (JSON, non blocking)
        run: |
          mkdir -p semgrep/results
          semgrep scan \
            --config "p/owasp-top-ten" \
            --config "p/nodejsscan" \
            --json \
            --output=semgrep/results/semgrep.json \
          || true

      
      - name: Import Semgrep report into DefectDojo
        if: always()
        uses: portswigger-cloud/defectdojo-import-scan@v1.0.1
        with:
          defectdojo-url: http://localhost:8080/
          defectdojo-username: ${{ secrets.DEFECTDOJO_USERNAME }}
          defectdojo-password: ${{ secrets.DEFECTDOJO_PASSWORD }}
          defectdojo-product-type: "web app"      # ex : "Web Application"
          defectdojo-product: "Test Defect Ci"           # ex : "MyNodeApp"
          defectdojo-environment-type: "Production"        # ou "Development", comme tu veux
          defectdojo-scan-type: "Semgrep JSON Report"
          defectdojo-engagement-name: "GitHub Actions Semgrep" # ex : "CI Semgrep"
          scan-results-file-name: semgrep/results/semgrep.json
